---
title: "Exercice 4"
author: "Ben Everad"
date: "14 1 2019"
output:
  html_document:
    df_print: paged
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# require the package
if (!("RPostgreSQL" %in% installed.packages())){
  install.packages("RPostgreSQL")
}
if (!("getPass" %in% installed.packages())){
  install.packages("getPass")
}
require(RPostgreSQL)
require(getPass)
require(ggplot2)

# establish the connection
drv <- dbDriver('PostgreSQL')
con <- dbConnect(drv, host='v45522.1blu.de', port=5432, user=getPass('Provide the user'), 
                 password=getPass('Provide the password'), dbname='datamanagement')
```


#try task 2
```{sql connection=con}
select r.hobo_id,
	count(r.temperature), 
	count(*) FILTER (WHERE temperature >0) AS warm,
	(SELECT count(*) from (SELECT 10760763 as hobo_id,
					ST_DISTANCE(ST_TRANSFORM(geom,3857),
					(SELECT ST_TRANSFORM(geom,3857) from hobo where hobo_id = 10760763 AND year = 2019)) AS distanz_m
					FROM hobo
					where hobo_id != 10760763 AND year = 2019 
			) foo
			WHERE foo.distanz_m <2000) as Count2019,
	(SELECT CASE WHEN 10760763 in (SELECT hobo_id from hobo where year = 2018) THEN 'richtig' else 'falsch' END) AS used2018,
	(SELECT CASE WHEN 10760763 in (SELECT hobo_id from hobo where year = 2017) THEN 'richtig' else 'falsch' END) AS used2017
	from raw_data as r
	WHERE r.tstamp > '2018-08-10' AND r.hobo_id = 10760763
	group by r.hobo_id

	
```


temp

```{sql connection=con}
SELECT DISTINCT(hobo_id)
    
    
    from hobo
    where year = 2019
    group By hobo_id
```

##try task 3

```{sql connection=con}
SELECT h.hobo_id,
  night.avgnight,
  day.avgday,
  ST_DISTANCE(ST_TRANSFORM(geom,3857),
					(SELECT ST_TRANSFORM(geom,3857) from hobo where hobo_id = 10760763 AND year = 2019)) AS   distanz_m,
	abs(night.avgnight - (SELECT avg(temperature) from raw_data
    WHERE hobo_id = 10760763 AND tstamp > '2018-9-10' AND (EXTRACT(HOUR FROM tstamp) <6 OR EXTRACT(HOUR FROM tstamp) >=18)
    group By hobo_id)) as diffnight,
    abs(day.avgday - (SELECT avg(temperature) from raw_data
    WHERE hobo_id = 10760763 AND tstamp > '2018-9-10' AND (EXTRACT(HOUR FROM tstamp) >=6 AND EXTRACT(HOUR FROM tstamp) <18)
    group By hobo_id)) as diffday
    
				
	
					
  from hobo AS h
    inner join (SELECT hobo_id,
    avg(temperature) as avgnight
    
    from raw_data
    WHERE tstamp > '2018-9-10' AND (EXTRACT(HOUR FROM tstamp) <6 OR EXTRACT(HOUR FROM tstamp) >=18)
    group By hobo_id) as night on (h.hobo_id = night.hobo_id)
    
    inner join (SELECT hobo_id,
    avg(temperature) as avgday
    
    from raw_data
    WHERE tstamp > '2018-9-10' AND (EXTRACT(HOUR FROM tstamp) >=6 AND EXTRACT(HOUR FROM tstamp) <18)
    group By hobo_id) as day on (h.hobo_id = day.hobo_id)
    
    WHERE h.year = 2019
```


##temp
```{sql connection = con}
SELECT hobo_id, avg(temperature) from raw_data
    WHERE hobo_id = 10760763 AND tstamp > '2018-9-10' AND (EXTRACT(HOUR FROM tstamp) <6 OR EXTRACT(HOUR FROM tstamp) >=18)
    group By hobo_id

```

# Loading spatial data to R



# cleanup
```{r}
dbDisconnect(con)
```





